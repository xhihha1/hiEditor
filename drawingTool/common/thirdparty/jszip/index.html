<!DOCTYPE html>
<html>

<head></head>
<script type="text/javascript" src="jszip.js"></script>
<body>
  <input type="file" id="upload" multiple />
  <hr />
  <button id="btn">Click</button>
</body>
<script>
  function loadFile(fileName) {
    return new Promise((resolve, reject) => {
      var oReq = new XMLHttpRequest();
      oReq.open("GET", fileName, true);
      oReq.responseType = "arraybuffer";
      oReq.onload = function (oEvent) {
        var arrayBuffer = oReq.response; // Note: not oReq.responseText
        if (arrayBuffer) {
          var uInt8Array = new Uint8Array(arrayBuffer);
          var i = uInt8Array.length;
          var biStr = new Array(i);
          while (i--) {
            biStr[i] = String.fromCharCode(uInt8Array[i]);
          }
          var data = biStr.join('');
          var base64 = window.btoa(data);
          // console.log('base64', base64)
          resolve(base64)
        }
      };
      oReq.send(null);
    })
  }


  document.getElementById('btn').onclick = function (e) {
    loadFile('a.jpg').then((base64) => {
      var zip = new JSZip();
      zip.file("Hello.txt", "Hello World\n");
      var img = zip.folder("images");
      img.file('b.jpg', base64, {
        base64: true
      });
      zip.generateAsync({
          type: "blob", // 壓縮型別
          compression: "DEFLATE", // STORE：預設不壓縮 DEFLATE：需要壓縮
          compressionOptions: {
            level: 9 // 壓縮等級1~9    1壓縮速度最快，9最優壓縮方式
            // [使用一張圖片測試之後1和9壓縮的力度不大，相差100K左右]
          }
        })
        .then(function (content) {
          // 壓縮的結果為blob型別
          console.info(content);
          exportDownload(content, "example.zip");
        });
    })
  }

  function exportDownload(blob, filename) {
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    link.remove();
  }

  document.getElementById('upload').onchange = function (e) {
    console.log(e)
    console.log(document.getElementById('upload').files.length)
    const files = document.getElementById('upload').files;
    for (var i = 0; i < files.length; i++) {
      console.log(files[i])
      // readFile(files[i], files[i].name)
    }
    readFiles(files)
  }

  function readFiles(files) {
    var reader = new FileReader();
    var zip = new JSZip();
    const count = 0
    function read (files, count, length) {
      const name = files[count].name
      const file = files[count]
      reader.onload = function () {
        count+=1
        const imgData = this.result;
        zip.file(name, imgData.substring(imgData.indexOf(",") + 1), {
          base64: true
        });
        if(count === length) {
          zip.generateAsync({
            type: "blob", // 壓縮型別
            compression: "DEFLATE", // STORE：預設不壓縮 DEFLATE：需要壓縮
            compressionOptions: {
              level: 9 // 壓縮等級1~9    1壓縮速度最快，9最優壓縮方式
              // [使用一張圖片測試之後1和9壓縮的力度不大，相差100K左右]
            }
          }).then(function (content) {
            // 壓縮的結果為blob型別
            console.info(content);
            exportDownload(content, "example.zip");
          });
        } else {
          read(files, count, files.length)
        }
      }
      reader.readAsDataURL(file);
    }
    read(files, count, files.length)
  }

  function readFile(file, name) {
    var reader = new FileReader();
    reader.readAsDataURL(file);
    var base64 = "";
    reader.onload = function () {
      console.log('Read', name, this.result)
      var imgData = this.result;
      var zip = new JSZip();
      // zip.file("Hello.txt", "Hello World\n");
      var img = zip.folder("images");
      img.file(name, imgData.substring(imgData.indexOf(",") + 1), {
        base64: true
      });
      zip.generateAsync({
          type: "blob", // 壓縮型別
          compression: "DEFLATE", // STORE：預設不壓縮 DEFLATE：需要壓縮
          compressionOptions: {
            level: 9 // 壓縮等級1~9    1壓縮速度最快，9最優壓縮方式
            // [使用一張圖片測試之後1和9壓縮的力度不大，相差100K左右]
          }
        })
        .then(function (content) {
          // 壓縮的結果為blob型別
          console.info(content);
          exportDownload(content, "example.zip");
        });
    }
  }

</script>

</html>